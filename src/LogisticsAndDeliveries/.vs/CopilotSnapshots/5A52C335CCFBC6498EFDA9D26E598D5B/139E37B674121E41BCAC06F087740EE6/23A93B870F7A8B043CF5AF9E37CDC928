using LogisticsAndDeliveries.Core.Abstractions;
using LogisticsAndDeliveries.Core.Results;
using LogisticsAndDeliveries.Domain.Packages.ValueObjects;
using System;
using System.Collections.Generic;

namespace LogisticsAndDeliveries.Domain.Packages
{
    public class Package : AggregateRoot
    {
        public PackageLabel PackageLabel { get; private set; }
        public EvidenceOfDelivery? EvidenceOfDelivery { get; private set; }
        public DeliveryStatus Status { get; private set; }
        private readonly List<DeliveryIncident> _deliveryIncidents = new();
        public IReadOnlyCollection<DeliveryIncident> DeliveryIncidents => _deliveryIncidents.AsReadOnly();

        public Package(Guid id, PackageLabel packageLabel) : base(id)
        {
            PackageLabel = packageLabel;
            Status = DeliveryStatus.Pending;
        }

        public void MarkInTransit()
        {
            if (Status != DeliveryStatus.Pending) 
                throw new DomainException(PackageErrors.InvalidStatusTransition);
            Status = DeliveryStatus.InTransit;
        }

        public void MarkDelivered(EvidenceOfDelivery evidence)
        {
            if (Status != DeliveryStatus.InTransit)
                throw new DomainException(PackageErrors.InvalidStatusTransition);
            EvidenceOfDelivery = evidence;
            Status = DeliveryStatus.Delivered;
        }

        public void MarkFailed()
        {
            if (Status != DeliveryStatus.InTransit)
                throw new DomainException(PackageErrors.InvalidStatusTransition);
            Status = DeliveryStatus.Failed;
        }

        public void Cancel()
        {
            if (Status == DeliveryStatus.Delivered)
                throw new DomainException(PackageErrors.CannotCancelDeliveredPackage);
            Status = DeliveryStatus.Cancelled;
        }

        public void RegisterDeliveryIncident(string type, string description, DateTime dateAndTimeOfDeliveryIncident)
        {
            var incident = new DeliveryIncident(Guid.NewGuid(), type, description, dateAndTimeOfDeliveryIncident);
            _deliveryIncidents.Add(incident);
        }
    }
}
